apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: facilitator-backend
  name: facilitator-backend
  namespace: acedatacloud
spec:
  progressDeadlineSeconds: 600
  replicas: 2
  revisionHistoryLimit: 5
  selector:
    matchLabels:
      app: facilitator-backend
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: facilitator-backend
    spec:
      containers:
        - env:
            - name: APP_ENV
              value: production
            - name: APP_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  key: SECRET_KEY
                  name: app
                  optional: false
            - name: PGSQL_DATABASE_FACILITATOR
              value: acedatacloud_facilitator
            - name: PGSQL_HOST
              valueFrom:
                secretKeyRef:
                  key: PGSQL_HOST
                  name: pgsql-qcloud
                  optional: false
            - name: PGSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: PGSQL_PASSWORD
                  name: pgsql-qcloud
                  optional: false
            - name: PGSQL_PORT
              valueFrom:
                secretKeyRef:
                  key: PGSQL_PORT
                  name: pgsql-qcloud
                  optional: false
            - name: PGSQL_USER
              valueFrom:
                secretKeyRef:
                  key: PGSQL_USER
                  name: pgsql-qcloud
                  optional: false
            - name: X402_PAY_TO
              valueFrom:
                secretKeyRef:
                  key: X402_PAY_TO
                  name: facilitator-shared
                  optional: false
            - name: X402_NETWORK
              valueFrom:
                secretKeyRef:
                  key: X402_NETWORK
                  name: facilitator-shared
                  optional: false
            - name: X402_USDC_CONTRACT
              valueFrom:
                secretKeyRef:
                  key: X402_USDC_CONTRACT
                  name: facilitator-shared
                  optional: false
            - name: X402_RPC_URL
              valueFrom:
                secretKeyRef:
                  key: X402_RPC_URL
                  name: facilitator-shared
                  optional: false
            - name: X402_SIGNER_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  key: X402_SIGNER_PRIVATE_KEY
                  name: facilitator-shared
                  optional: false
            - name: X402_SIGNER_ADDRESS
              valueFrom:
                secretKeyRef:
                  key: X402_SIGNER_ADDRESS
                  name: facilitator-shared
                  optional: false
            - name: X402_GAS_LIMIT
              value: "250000"
            - name: X402_TX_TIMEOUT_SECONDS
              value: "120"
            - name: X402_MAX_FEE_PER_GAS_WEI
              value: "0"
            - name: X402_MAX_PRIORITY_FEE_PER_GAS_WEI
              value: "0"
          image: ghcr.io/acedatacloud/facilitator-backend:${TAG}
          imagePullPolicy: IfNotPresent
          name: facilitator-backend
          ports:
            - containerPort: 8000
              protocol: TCP
          resources:
            limits:
              cpu: 200m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 256Mi
          securityContext:
            privileged: false
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
      dnsPolicy: ClusterFirst
      imagePullSecrets:
        - name: docker-registry
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
